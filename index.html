<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tecla Ultra Avan√ßada</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; margin:0; padding:20px; background:#f8fafc; color:#333; }
    header { text-align:center; padding:15px; background:#1d4ed8; color:white; border-radius:12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .container { max-width:1000px; margin:auto; background:white; padding:30px; border-radius:18px; box-shadow:0 10px 20px rgba(0,0,0,0.05); }
    select, input[type="text"] { width:100%; padding:14px; margin-top:10px; font-size:16px; border:2px solid #ccc; border-radius:10px; transition: border-color 0.3s; }
    select:focus, input[type="text"]:focus { border-color: #2563eb; outline: none; }
    button { background:#2563eb; color:white; padding:14px 25px; font-size:16px; border:none; border-radius:10px; margin-top:10px; cursor:pointer; transition: background-color 0.3s, transform 0.1s; }
    button:hover { background:#1e40af; }
    button:active { transform: scale(0.98); }
    .pictogramas { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; justify-content: center; }
    .pictograma { flex:1 1 30%; max-width: calc(33.33% - 10px); background:#eff6ff; padding:16px; font-size:24px; text-align:center; border-radius:12px; cursor:pointer; border:1px solid #bfdbfe; transition: background-color 0.3s, box-shadow 0.3s; }
    .pictograma:hover { background:#dbeafe; box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2); }
    #saida, #alertas, #orientacaoDala { margin-top:25px; font-size:18px; padding:20px; border-radius:12px; }
    #saida { background:#e0f2fe; color:#0c4a6e; border-left: 5px solid #38bdf8; }
    #alertas { background:#fef3c7; color:#92400e; border-left: 5px solid #fbbf24; }
    #orientacaoDala { background:#ecfdf5; color:#065f46; border-left: 5px solid #10b981; }
    .alert { margin-top:10px; padding:12px; border-radius:8px; font-weight:bold; }
    .barra-versoes { display:flex; justify-content:space-around; margin-top:25px; gap:10px; }
    .barra { padding:12px; border-radius:10px; cursor:pointer; flex:1; text-align:center; color:white; font-weight:bold; transition: opacity 0.3s; }
    .barra.free { background:#10b981;} /* Green */
    .barra.intermediate { background:#f97316;} /* Orange */
    .barra.premium { background:#ef4444;} /* Red */
    .barra:not(.active) { opacity: 0.7; }
    .barra.active { box-shadow: 0 0 0 4px #2563eb; opacity: 1; }
    .respiracao { margin-top:15px; font-size:18px; font-weight: bold; color:#1e40af; text-align: center; }
    .iframe-versao { width:100%; height:300px; margin-top:20px; border:2px solid #2563eb; border-radius:12px; }
    canvas { margin-top:20px; border:1px solid #e5e7eb; border-radius:12px; background:#f9fafb; width: 100%; height: 250px; }
    #historicoVersoes { margin-top:15px; padding-left:0; list-style:none; }
    #historicoVersoes li { cursor:pointer; margin-bottom:8px; padding:8px; background:#f3f4f6; border-radius:6px; transition: background-color 0.2s; }
    #historicoVersoes li:hover { background:#e5e7eb; }
    .loading-dot { animation: dot-flicker 1.5s infinite; }
    .loading-dot:nth-child(2) { animation-delay: 0.5s; }
    .loading-dot:nth-child(3) { animation-delay: 1s; }
    @keyframes dot-flicker {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
</style>
</head>
<body>
<div class="container">
    <header>
        <h1 class="text-3xl font-extrabold">üß† Tecla Ultra Avan√ßada</h1>
        <p class="text-sm mt-1">Hist√≥rico, gr√°ficos de alertas, predi√ß√£o avan√ßada e Orienta√ß√£o Imediata Dala</p>
    </header>

    <div class="mt-8">
        <label for="idioma" class="text-sm font-medium text-gray-700">üåç Escolha o idioma:</label>
        <select id="idioma">
            <option value="pt-PT">Portugu√™s</option>
            <option value="en-US">English</option>
        </select>

        <label for="entrada" class="text-sm font-medium text-gray-700 mt-4 block">üí¨ Digite ou fale o que deseja:</label>
        <div class="flex space-x-2">
            <input type="text" id="entrada" placeholder="Ex: Quero brincar com o carrinho" class="flex-grow" />
            <button onclick="responder()" class="flex-shrink-0">üîä Tecla</button>
            <button onclick="falar()" class="flex-shrink-0">üéôÔ∏è Falar</button>
        </div>

        <div class="pictogramas">
            <div class="pictograma" onclick="usarFrase('Quero comer')">üçΩÔ∏è Comer</div>
            <div class="pictograma" onclick="usarFrase('Preciso ir ao banheiro')">üöª Banheiro</div>
            <div class="pictograma" onclick="usarFrase('Estou feliz!')">üòä Feliz</div>
            <div class="pictograma" onclick="usarFrase('Quero brincar')">üß∏ Brincar</div>
            <div class="pictograma" onclick="usarFrase('Estou triste')">üò¢ Triste</div>
            <div class="pictograma" onclick="usarFrase('Estou com dor')">ü§ï Dor</div>
        </div>

        <div class="barra-versoes">
            <div class="barra free active" id="btn-free" onclick="abrirVersao('free')">Gratuita</div>
            <div class="barra intermediate" id="btn-intermediate" onclick="abrirVersao('intermediate')">Intermedi√°ria</div>
            <div class="barra premium" id="btn-premium" onclick="abrirVersao('premium')">Premium</div>
        </div>

        <!-- Feedback e Alertas -->
        <div id="saida"></div>
        <!-- Alertas Imediatos e de Predi√ß√£o aparecer√£o aqui -->
        <div id="alertas"></div> 
        <div id="orientacaoDala">
            <h3 class="font-bold text-lg mb-2 text-green-700">‚ú® Orienta√ß√£o Imediata Dala</h3>
            <p id="dala-insight-text" class="text-sm text-green-600 italic">Aguardando a pr√≥xima intera√ß√£o para an√°lise.</p>
        </div>
        <div class="respiracao" id="respiracao"></div>

        <!-- Hist√≥rico e Gr√°fico (Dashboard T√©cnico) -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h3 class="text-xl font-bold mb-3 text-gray-700">Log de Hist√≥rico (√öltimos)</h3>
                <ul id="historicoVersoes"></ul>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-3 text-gray-700">Gr√°fico de Alertos por Vers√£o</h3>
                <canvas id="graficoAlertas"></canvas>
            </div>
        </div>
        
        <!-- Iframe da Vers√£o (Ainda est√°tico para simula√ß√£o) -->
        <iframe class="iframe-versao" id="iframeVersao" src="https://placehold.co/800x300/e0f2fe/1e40af?text=Simula√ß√£o+Vers√£o+Tecla+GRATUITA"></iframe>
    </div>
</div>

<script>
    // --- CONSTANTES PARA A PREDI√á√ÉO AVAN√áADA ---
    const JANELA_TEMPO_MS = 10 * 60 * 1000; // 10 minutos em milissegundos (600000ms)
    const LIMITE_PONTUACAO_PREDICAO = 5; // Pontos para disparar o alerta de risco elevado

    // Configura√ß√£o Gemini API
    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    let versaoAtual = 'free';
    let dadosLogs = [];
    const MAX_LOGS = 50; 
    
    // Vari√°veis do Gr√°fico
    let chart;
    let ctx;
    const cores = {free:'#10b981', intermediate:'#f97316', premium:'#ef4444'};

    // -----------------------------------------------------------
    // 1. L√ìGICA DE INTERA√á√ÉO E RESPOSTA
    // -----------------------------------------------------------
    
    /**
     * Calcula a pontua√ß√£o de severidade de uma frase e determina se √© um alerta simples.
     */
    function calcularSeveridadeAlerta(frase) {
        const texto = frase.toLowerCase();
        let score = 0;
        let isAlert = false;

        // Define pesos para as palavras-chave (Maior peso = Maior urg√™ncia)
        const pesos = {
            'dor': 3,
            'triste': 2,
            'bravo': 1,
            'irritado': 1,
            'zangado': 1,
            'doente': 2,
            'mal': 1, // Ex: "Estou mal"
        };

        for (const palavra in pesos) {
            if (texto.includes(palavra)) {
                score += pesos[palavra];
                isAlert = true;
            }
        }
        
        // Se a crian√ßa usar MAI√öSCULAS ou muitos pontos de exclama√ß√£o, aumenta-se o peso emocional
        if (frase.toUpperCase() === frase && frase.length > 5) {
            score += 1;
        }
        if ((frase.match(/!/g) || []).length >= 2) {
            score += 1;
        }

        return { isAlert, score };
    }

    async function responder() {
        const entrada = document.getElementById("entrada").value;
        if (!entrada.trim()) return; // Ignora entradas vazias
        const idioma = document.getElementById("idioma").value;
        const saidaDiv = document.getElementById("saida");
        
        // 1. Calcula a severidade da frase
        const { isAlert, score } = calcularSeveridadeAlerta(entrada);
        
        // 2. Resposta Imediata da Tecla
        let resposta = idioma === 'pt-PT'
            ? `Tecla disse: "${entrada}". Entendemos a sua necessidade com carinho.`
            : `Tecla said: "${entrada}". We hear your need with care.`;

        saidaDiv.innerText = resposta;
        falarTexto(resposta, idioma);
        
        // 3. Processamento e Logs
        salvarFrase(entrada, isAlert, score); // Salva a pontua√ß√£o
        processarEntrada(entrada, isAlert); // Dispara alertas e predi√ß√£o
        
        // 4. Orienta√ß√£o Dala (s√≥ em caso de alerta OU na vers√£o premium)
        if (isAlert || versaoAtual === 'premium') {
            await generateDalaInsight(entrada);
        } else {
            document.getElementById("dala-insight-text").textContent = "Aguardando a pr√≥xima intera√ß√£o para an√°lise.";
            document.getElementById("orientacaoDala").classList.add('hidden');
        }

        // 5. Atualiza√ß√µes Visuais
        atualizarHistorico();
        atualizarGrafico();
    }

    function usarFrase(texto){
        document.getElementById("entrada").value = texto;
        responder();
    }

    // -----------------------------------------------------------
    // 2. INTEGRA√á√ÉO LLM (Dala)
    // -----------------------------------------------------------
    
    /**
     * Gera a Orienta√ß√£o Imediata Dala usando a LLM. (Fun√ß√£o inalterada)
     */
    async function generateDalaInsight(entradaDaCrianca) {
        const insightDiv = document.getElementById('orientacaoDala');
        const insightText = document.getElementById('dala-insight-text');
        
        insightDiv.classList.remove('hidden');
        insightText.innerHTML = `<div class="flex items-center space-x-2">
            <span>Dala est√° a gerar a Orienta√ß√£o Imediata...</span>
            <span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>
        </div>`;
        
        const systemPrompt = "Atue como Dala, um guia compassivo e protetor para terapeutas/cuidadores. Analise a frase da crian√ßa e gere uma 'Orienta√ß√£o de A√ß√£o Imediata' concisa (m√°ximo 3 frases) e pr√°tica. A orienta√ß√£o deve ser focada em validar a emo√ß√£o da crian√ßa e oferecer um primeiro passo de conex√£o. Use um tom caloroso e de apoio. NUNCA use marcadores, listas ou sub-cabe√ßalhos.";
        
        const userQuery = `A crian√ßa disse: "${entradaDaCrianca}". Qual √© a Orienta√ß√£o Imediata para o cuidador/terapeuta?`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        try {
            // L√≥gica de backoff omitida para brevidade, mas deve ser usada em ambiente real
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                insightText.textContent = text;
            } else {
                throw new Error("Resposta da LLM vazia.");
            }

        } catch (error) {
            console.error("Erro na chamada da API Gemini (Dala):", error);
            // Implementa√ß√£o de Fallback
            insightText.innerHTML = `<p class="text-red-600">Falha na comunica√ß√£o com Dala. Tente novamente ou use a Orienta√ß√£o manual: Ofere√ßa um abra√ßo e pergunte gentilmente "O que podemos fazer juntos agora?".</p>`;
        }
    }

    // -----------------------------------------------------------
    // 3. L√ìGICA DE ALERTA, LOGS E PREDI√á√ÉO AVAN√áADA
    // -----------------------------------------------------------

    function falarTexto(texto, idioma){
        const synth = window.speechSynthesis;
        const utterThis = new SpeechSynthesisUtterance(texto);
        utterThis.lang = idioma;
        synth.speak(utterThis);
    }

    function falar(){
        const idioma = document.getElementById("idioma").value;
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = idioma;
        recognition.start();
        recognition.onresult = function(event){
            const textoFalado = event.results[0][0].transcript;
            document.getElementById("entrada").value = textoFalado;
            responder();
        }
    }

    function salvarFrase(frase, isAlert, score){
        // Agora salva a pontua√ß√£o de severidade tamb√©m
        dadosLogs.push({versao: versaoAtual, frase, alerta: isAlert, score: score, timestamp: Date.now()}); 
        if(dadosLogs.length > MAX_LOGS) dadosLogs.shift();
    }

    /**
     * L√≥gica de Predi√ß√£o Avan√ßada baseada em peso e tempo.
     * @returns {object} { isTriggered: boolean, score: number }
     */
    function predicaoPreventiva(){
        if(dadosLogs.length === 0) return { isTriggered: false, score: 0 };
        
        const agora = Date.now();
        let pontuacaoTotal = 0;
        
        // Filtra logs que ocorreram dentro da janela de tempo (√∫ltimos 10 minutos)
        const logsRecentes = dadosLogs.filter(log => (agora - log.timestamp) <= JANELA_TEMPO_MS);
        
        // Soma a pontua√ß√£o de todos os logs recentes
        logsRecentes.forEach(log => {
            pontuacaoTotal += log.score;
        });
        
        const isTriggered = pontuacaoTotal >= LIMITE_PONTUACAO_PREDICAO;
        
        return { isTriggered, score: pontuacaoTotal };
    }

    function processarEntrada(entrada, isAlert){
        const alertasDiv = document.getElementById("alertas");
        alertasDiv.innerHTML = ''; // Limpa alertas anteriores

        // 1. Alerta Imediato (Baseado APENAS nesta frase)
        if(isAlert){
            const div = document.createElement('div');
            div.className = 'alert bg-yellow-100 border-yellow-500 text-yellow-700';
            div.innerText = '‚ö†Ô∏è ALERTA IMEDIATO: A frase cont√©m indicadores de stress ou tristeza.';
            alertasDiv.appendChild(div);
            // Inicia a respira√ß√£o de ancoragem para o cuidador, mesmo que seja s√≥ um alerta imediato
            iniciarRespiracao(); 
        }
        
        // 2. Predi√ß√£o Avan√ßada (Baseada em hist√≥rico de 10 minutos)
        const predicao = predicaoPreventiva();

        if(predicao.isTriggered){
            const div = document.createElement('div');
            div.className = 'alert bg-red-100 border-red-500 text-red-700';
            div.innerText = `üö® PREDI√á√ÉO AVAN√áADA - RISCO ELEVADO: Acumulou ${predicao.score} pontos de alerta (Limite: ${LIMITE_PONTUACAO_PREDICAO}) nos √∫ltimos 10 minutos. Necess√°rio Ancoragem Imediata!`;
            alertasDiv.appendChild(div);
            falarTexto("Aten√ß√£o! Risco de crise elevado!", document.getElementById("idioma").value);
            // Garante que o processo de respira√ß√£o √© iniciado ou reiniciado
            iniciarRespiracao(); 
        }
    }

    function iniciarRespiracao(){
        const respDiv = document.getElementById("respiracao");
        // Verifica se j√° est√° em andamento para n√£o iniciar m√∫ltiplos timers
        if(respDiv.dataset.running === 'true') return; 

        respDiv.dataset.running = 'true';
        let cont = 0;
        respDiv.innerText = "üåÄ T√©cnica de Ancoragem: Respire fundo, cuidador.";
        const intervalo = setInterval(()=>{
            const fases = ["Inspire... (4s) üå¨Ô∏è","Segure... (4s) ‚úã","Expire... (4s) üí®","Segure... (4s) ‚úã"];
            respDiv.innerText = fases[cont%4];
            cont++;
            if(cont > 11){ // Ciclo completo de 3 respira√ß√µes
                clearInterval(intervalo); 
                respDiv.innerText = ""; 
                respDiv.dataset.running = 'false';
            }
        }, 1500); // Intervalo reduzido para simula√ß√£o r√°pida
    }

    // -----------------------------------------------------------
    // 4. L√ìGICA DE VERS√ïES E VISUALIZA√á√ÉO
    // -----------------------------------------------------------

    function abrirVersao(versao){
        document.getElementById(`btn-${versaoAtual}`).classList.remove('active');
        versaoAtual = versao;
        document.getElementById(`btn-${versaoAtual}`).classList.add('active');
        
        let iframe = document.getElementById("iframeVersao");
        let links = {
            free:'https://placehold.co/800x300/e0f2fe/1e40af?text=Simula√ß√£o+Vers√£o+Tecla+GRATUITA',
            intermediate:'https://placehold.co/800x300/fef3c7/92400e?text=Simula√ß√£o+Vers√£o+Tecla+INTERMEDI√ÅRIA',
            premium:'https://placehold.co/800x300/fee2e2/991b1b?text=Tecla+Premium+-+Recursos+Avan√ßados+Incorporados'
        };
        iframe.src = links[versao];
        
        console.log(`Vers√£o selecionada: ${versao}`);
        
        atualizarHistorico();
        atualizarGrafico();
        
        if (versao === 'premium' && dadosLogs.length > 0) {
            generateDalaInsight(`(An√°lise Premium) Revisite a √∫ltima frase: ${dadosLogs[dadosLogs.length - 1].frase}`);
        } else {
             document.getElementById("dala-insight-text").textContent = "Aguardando a pr√≥xima intera√ß√£o para an√°lise.";
             document.getElementById("orientacaoDala").classList.add('hidden');
        }
    }

    function atualizarHistorico(){
        const lista = document.getElementById("historicoVersoes");
        lista.innerHTML = "";
        
        const logsToShow = dadosLogs.slice(-10).reverse(); 
        
        logsToShow.forEach(log => {
            const alertClass = log.alerta ? 'font-bold text-red-700 bg-red-50' : 'text-gray-700';
            const li = document.createElement("li");
            li.className = `${alertClass} p-2 rounded-lg hover:bg-gray-200 cursor-pointer text-sm`;
            // Mostra a pontua√ß√£o de severidade no hist√≥rico
            li.innerText = `[${log.versao.toUpperCase()}] (Score: ${log.score}) ${log.frase} ${log.alerta ? 'üö®' : ''}`;
            li.onclick = () => { document.getElementById("entrada").value = log.frase; responder(); };
            lista.appendChild(li);
        });
        
        if (logsToShow.length === 0) {
            lista.innerHTML = '<li class="text-gray-500">Nenhuma intera√ß√£o registrada ainda.</li>';
        }
    }

    function atualizarGrafico(){
        if (!ctx) return; 

        // Prepara os dados de contagem
        let counts = {free: 0, intermediate: 0, premium: 0};
        dadosLogs.forEach(l => { 
            // Agora conta pela PONTUA√á√ÉO, n√£o apenas se √© um alerta
            counts[l.versao] += l.score; 
        });
        
        const labels = Object.keys(counts).map(v => v.charAt(0).toUpperCase() + v.slice(1));
        const dataValues = Object.values(counts);
        const backgroundColors = Object.values(cores);

        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pontua√ß√£o de Alertas Acumulados',
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(c => c.replace('10b981', '059669').replace('f97316', 'c2410c').replace('ef4444', 'b91c1c')), 
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Pontua√ß√£o Total de Severidade'
                        },
                        ticks: {
                            precision: 0 
                        }
                    },
                    x: {
                         title: {
                            display: true,
                            text: 'Vers√£o Tecla'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    window.onload = function(){
        // Inicializa o contexto do gr√°fico
        ctx = document.getElementById("graficoAlertas").getContext("2d"); 

        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js";
        
        // Garante que a l√≥gica de inicializa√ß√£o s√≥ corre AP√ìS o Chart.js estar carregado
        script.onload = () => {
            document.getElementById("orientacaoDala").classList.add('hidden');
            // A fun√ß√£o abrirVersao chama atualizarGrafico, agora que Chart est√° definido.
            abrirVersao('free'); 
        };
        document.head.appendChild(script);
        
        // A chamada foi movida para dentro de script.onload para resolver o problema de temporiza√ß√£o.
    };
</script>
</body>
</html>

